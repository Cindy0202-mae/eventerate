<div class="container">
  <h1>Preview Event Plan</h1>
  <h2><%= @event.title %></h2>
  <p><strong>Date: </strong><%= @event.date %></p>
  <p><strong>Duration: </strong><%= @event.duration %> minutes</p>

  <h3>Here are the activity suggestions</h3>
  <% if @generated_activities.present? %>
    <%= form_with url: save_event_plan_event_path(@event), method: :post do %>
      <%= hidden_field_tag :event_id, @event.id %>
      <%= hidden_field_tag :commit_action, "" %>

      <% @generated_activities.each_with_index do |activity, index| %>
        <div class="card mb-3 activity-preview">
          <div class="card-body">
            <h4 class="card-title"><%= activity.title %></h4>
            <% description_parts = activity.description.split("\n\n") %>
            <% main_description = description_parts[0].sub(/\*\*Description\*\*:\s*/, '') %>
            <% instructions = description_parts[1].to_s.sub(/\*\*Step-by-Step Instructions\*\*:\s*/, '') %>
            <% materials = description_parts[2].to_s.sub(/\*\*Materials\*\*:\s*/, '') %>
            <p><%= main_description %></p>
            <% instructions.split("\n").each do |step| %>
              <p><%= step %></p>
            <% end %>
            <p><strong>Materials:</strong> <%= materials %></p>
            <p><strong>Genres:</strong> <%= activity.genres.join(', ') %></p>
            <p><strong>Age Range:</strong> <%= activity.age %></p>

            <!-- Hidden fields to preserve activity details -->
            <input type="hidden" name="activities[][title]" value="<%= activity.title %>">
            <input type="hidden" name="activities[][description]" value="<%= activity.description %>">
            <input type="hidden" name="activities[][genres]" value="<%= activity.genres.to_json %>">
            <input type="hidden" name="activities[][age]" value="<%= activity.age %>">

            <!-- Checkbox to select activity for regeneration -->
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="selected_activity_titles[]" value="<%= activity.title %>" id="activity_<%= index %>">
              <label class="form-check-label" for="activity_<%= index %>">Keep this activity</label>
            </div>
          </div>
        </div>
      <% end %>
      <%= submit_tag 'Save Event Plan', class: 'btn btn-primary', onclick: "document.getElementById('commit_action').value = 'save'" %>
      <%= submit_tag 'Regenerate Activities', class: 'btn btn-secondary', onclick: "document.getElementById('commit_action').value = 'regenerate'" %>
    <% end %>
  <% else %>
    <p>No activities were generated. Please try again.</p>
  <% end %>
  <%= link_to 'Discard Event Plan', new_event_path, class: 'btn btn-secondary' %>
</div>
